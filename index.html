<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ensembl Annotator â€” Venn + Comparison Table</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;max-width:1100px;margin:20px auto;color:#111;padding:0 16px}
    h1{font-size:18px;margin:0 0 8px}
    label{display:block;margin-top:12px;font-weight:600}
    input[type="text"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace}
    button{margin-top:12px;padding:10px 14px;border-radius:8px;border:0;background:#0b71f0;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:default}
    .meta{font-size:13px;color:#555;margin-top:8px}
    .spinner{display:inline-block;width:12px;height:12px;border-radius:50%;border:2px solid rgba(0,0,0,0.15);border-top-color:#0b71f0;animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* layout */
    .container { display:flex; gap:18px; margin-top:14px; align-items:flex-start; }
    .left { width:160px; }
    .left .controls { background:#f7f9fc;border:1px solid #e6eef8;border-radius:8px;padding:12px; }
    .icon-btn { display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; cursor:pointer; margin-bottom:8px; user-select:none; }
    .icon-btn:hover { background:#eef6ff; }
    .icon-btn.active { background:#0b71f0;color:#fff; }
    .icon-emoji { font-size:20px; width:28px; text-align:center; }
    .small { font-size:13px; color:#444; }

    .right { flex:1; min-height:320px; }
    .panel { border-radius:8px; border:1px solid #eef2f8; padding:12px; margin-bottom:12px; background:#fff; box-shadow:0 1px 4px rgba(10,20,30,0.02); }
    .panel h2 { margin:0 0 8px; font-size:15px; display:flex; justify-content:space-between; align-items:center; }
    .venn-container { width:100%; height:300px; display:flex; align-items:center; justify-content:center; }
    .stats { font-size:13px; color:#333; margin-top:8px; }
    #output { white-space:pre-wrap; background:#0f1720; color:#e6eef8; padding:12px; border-radius:8px; margin-top:14px; min-height:140px; overflow:auto; border:1px solid #253046; display:none; }

    /* table comparison */
    .compare-table { width:100%; border-collapse:collapse; margin-top:12px; }
    .compare-headers { display:flex; gap:12px; }
    .col { flex:1; border:1px solid #edf2f8; border-radius:6px; padding:8px; min-height:160px; max-height:320px; overflow:auto; background:#fbfdff; }
    .col h4 { margin:0 0 6px; font-size:13px; }
    .item { font-family:monospace; font-size:13px; padding:4px 0; border-bottom:1px dashed rgba(0,0,0,0.03); }

    .hint { font-size:13px; color:#666; margin-top:8px; }
  </style>
  <!-- d3 + venn.js from CDN -->
  <script src="https://unpkg.com/d3@5"></script>
  <script src="https://unpkg.com/venn.js@0.2.20/build/venn.min.js"></script>
</head>
<body>
  <h1>Ensembl Annotator â€” Venn + Comparison Table</h1>

  <div>
    <label for="ensembl1">Ensembl ID 1</label>
    <input id="ensembl1" type="text" placeholder="ENSG00000141510" />

    <label for="ensembl2">Ensembl ID 2</label>
    <input id="ensembl2" type="text" placeholder="ENSG00000139618" />

    <div class="meta">This page POSTS the two IDs to your local server and uses the returned JSON for frontend-only Venn comparisons and a comparison table.</div>

    <button id="submit">Submit</button>
    <span id="status" class="meta"></span>
  </div>

  <div class="container">
    <div class="left">
      <div class="controls">
        <div id="btn-goids" class="icon-btn" title="Compare by GO IDs">
          <span class="icon-emoji">ðŸ§¬</span>
          <div>
            <div style="font-weight:700">GO IDs</div>
            <div class="small">Compare by GO identifiers</div>
          </div>
        </div>

        <div id="btn-goterms" class="icon-btn" title="Compare by GO Terms">
          <span class="icon-emoji">ðŸ“š</span>
          <div>
            <div style="font-weight:700">GO Terms</div>
            <div class="small">Compare by GO term strings</div>
          </div>
        </div>

        <div id="btn-symbols" class="icon-btn" title="Compare by Gene Symbol">
          <span class="icon-emoji">ðŸ”¤</span>
          <div>
            <div style="font-weight:700">Gene Symbol</div>
            <div class="small">Compare by gene symbol (fallback: Ensembl)</div>
          </div>
        </div>

        <div id="btn-raw" class="icon-btn" title="Show raw JSON response">
          <span class="icon-emoji">ðŸ“„</span>
          <div>
            <div style="font-weight:700">Raw data</div>
            <div class="small">Toggle raw server JSON</div>
          </div>
        </div>

        <div class="hint">Click an option to open the right panel (A vs B) â€” venn + table.</div>
      </div>
    </div>

    <div class="right">
      <!-- GO IDs panel -->
      <div id="panel-goids" class="panel" style="display:none">
        <h2>GO IDs <span id="goids-count"></span></h2>
        <div id="venn-goids" class="venn-container"></div>
        <div id="goids-stats" class="stats"></div>

        <div class="compare-headers" style="margin-top:12px">
          <div class="col" id="goids-col-a"><h4>A only</h4><div id="goids-a-list"></div></div>
          <div class="col" id="goids-col-both"><h4>Shared</h4><div id="goids-both-list"></div></div>
          <div class="col" id="goids-col-b"><h4>B only</h4><div id="goids-b-list"></div></div>
        </div>
      </div>

      <!-- GO Terms panel -->
      <div id="panel-goterms" class="panel" style="display:none">
        <h2>GO Terms <span id="goterms-count"></span></h2>
        <div id="venn-goterms" class="venn-container"></div>
        <div id="goterms-stats" class="stats"></div>

        <div class="compare-headers" style="margin-top:12px">
          <div class="col" id="goterms-col-a"><h4>A only</h4><div id="goterms-a-list"></div></div>
          <div class="col" id="goterms-col-both"><h4>Shared</h4><div id="goterms-both-list"></div></div>
          <div class="col" id="goterms-col-b"><h4>B only</h4><div id="goterms-b-list"></div></div>
        </div>
      </div>

      <!-- Symbols panel -->
      <div id="panel-symbols" class="panel" style="display:none">
        <h2>Gene Symbol <span id="symbols-count"></span></h2>
        <div id="venn-symbols" class="venn-container"></div>
        <div id="symbols-stats" class="stats"></div>

        <div class="compare-headers" style="margin-top:12px">
          <div class="col" id="symbols-col-a"><h4>A only</h4><div id="symbols-a-list"></div></div>
          <div class="col" id="symbols-col-both"><h4>Shared</h4><div id="symbols-both-list"></div></div>
          <div class="col" id="symbols-col-b"><h4>B only</h4><div id="symbols-b-list"></div></div>
        </div>
      </div>

      <!-- Raw JSON output (hidden by default) -->
      <div id="output">Server response will appear here...</div>
    </div>
  </div>

<script>
/* Endpoint */
const API_ENDPOINT = "http://127.0.0.1:5000/annotate";

/* DOM */
const en1 = document.getElementById('ensembl1');
const en2 = document.getElementById('ensembl2');
const btn = document.getElementById('submit');
const out = document.getElementById('output');
const status = document.getElementById('status');

/* Left controls */
const btnGoIds = document.getElementById('btn-goids');
const btnGoTerms = document.getElementById('btn-goterms');
const btnSymbols = document.getElementById('btn-symbols');
const btnRaw = document.getElementById('btn-raw');

/* Panels */
const panelGoIds = document.getElementById('panel-goids');
const panelGoTerms = document.getElementById('panel-goterms');
const panelSymbols = document.getElementById('panel-symbols');

/* Panel lists */
const goidsAList = document.getElementById('goids-a-list');
const goidsBothList = document.getElementById('goids-both-list');
const goidsBList = document.getElementById('goids-b-list');

const gotermsAList = document.getElementById('goterms-a-list');
const gotermsBothList = document.getElementById('goterms-both-list');
const gotermsBList = document.getElementById('goterms-b-list');

const symbolsAList = document.getElementById('symbols-a-list');
const symbolsBothList = document.getElementById('symbols-both-list');
const symbolsBList = document.getElementById('symbols-b-list');

/* Count spans */
const goidsCount = document.getElementById('goids-count');
const gotermsCount = document.getElementById('goterms-count');
const symbolsCount = document.getElementById('symbols-count');

/* Stats elements */
const goidsStats = document.getElementById('goids-stats');
const gotermsStats = document.getElementById('goterms-stats');
const symbolsStats = document.getElementById('symbols-stats');

let lastResponse = null;

/* helpers */
function setBusy(b, msg) {
  btn.disabled = b;
  status.textContent = msg || "";
  const existing = document.querySelector('.spinner');
  if (b && !existing) {
    const s = document.createElement('span'); s.className = 'spinner'; status.appendChild(s);
  } else if (!b && existing) existing.remove();
}

function tryPretty(text) {
  try {
    const obj = JSON.parse(text);
    return JSON.stringify(obj, null, 2);
  } catch(e) {
    return text;
  }
}

async function postJSON(body){
  return fetch(API_ENDPOINT, {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'Accept': '*/*'},
    body: JSON.stringify(body)
  });
}

async function getFallback(params){
  const url = new URL(API_ENDPOINT);
  Object.keys(params).forEach(k => url.searchParams.set(k, params[k] || ''));
  return fetch(url.toString(), {method:'GET', headers:{'Accept':'*/*'}});
}

/* normalize values (trim, collapse whitespace) */
function normalizeString(x) {
  if (x === null || x === undefined) return "";
  return String(x).trim();
}
function normalizeGOId(x) {
  // GO IDs are typically uppercase like GO:0005886
  return normalizeString(x).toUpperCase();
}
function normalizeGOTerm(x) {
  // Keep case but trim
  return normalizeString(x);
}
function normalizeSymbol(x) {
  return normalizeString(x);
}

/* build arrays/sets for each axis from response */
function buildSets(resp, axis) {
  if (!resp || !resp.annotations || resp.annotations.length < 2) return null;
  const a0 = resp.annotations[0];
  const a1 = resp.annotations[1];

  if (axis === 'go_ids') {
    const arrA = Array.isArray(a0.go_ids) ? a0.go_ids.map(normalizeGOId).filter(Boolean) : [];
    const arrB = Array.isArray(a1.go_ids) ? a1.go_ids.map(normalizeGOId).filter(Boolean) : [];
    const setA = new Set(arrA);
    const setB = new Set(arrB);
    return { arrA, arrB, setA, setB };
  } else if (axis === 'go_terms') {
    const arrA = Array.isArray(a0.go_terms) ? a0.go_terms.map(normalizeGOTerm).filter(Boolean) : [];
    const arrB = Array.isArray(a1.go_terms) ? a1.go_terms.map(normalizeGOTerm).filter(Boolean) : [];
    const setA = new Set(arrA);
    const setB = new Set(arrB);
    return { arrA, arrB, setA, setB };
  } else if (axis === 'symbol') {
    const valA = (a0.gene_symbol && a0.gene_symbol.trim()) ? a0.gene_symbol.trim() : a0.ensembl_id;
    const valB = (a1.gene_symbol && a1.gene_symbol.trim()) ? a1.gene_symbol.trim() : a1.ensembl_id;
    const arrA = [normalizeSymbol(valA)];
    const arrB = [normalizeSymbol(valB)];
    const setA = new Set(arrA);
    const setB = new Set(arrB);
    return { arrA, arrB, setA, setB };
  }
  return null;
}

/* set intersection helper */
function setIntersection(setA, setB) {
  const out = new Set();
  for (const x of setA) if (setB.has(x)) out.add(x);
  return out;
}

/* set difference */
function setDifference(setA, setB) {
  const out = new Set();
  for (const x of setA) if (!setB.has(x)) out.add(x);
  return out;
}

/* union array sorted */
function unionSorted(setA, setB) {
  return Array.from(new Set([...setA, ...setB])).sort();
}

/* draw venn */
function drawVenn(containerId, setA, setB, labelA, labelB, statsEl, countSpan) {
  const container = d3.select("#" + containerId);
  container.selectAll("*").remove();

  const inter = setIntersection(setA, setB);

  const data = [
    { sets: [0], size: setA.size, label: labelA },
    { sets: [1], size: setB.size, label: labelB },
    { sets: [0,1], size: inter.size, label: labelA + " âˆ© " + labelB }
  ];

  // render diagram
  try {
    venn.VennDiagram().width(container.node().clientWidth).height(container.node().clientHeight)(container.datum(data), data);
  } catch(e) {
    // fallback: just clear
    container.selectAll("*").remove();
  }

  // stats
  const onlyA = setDifference(setA, setB).size;
  const onlyB = setDifference(setB, setA).size;
  const unionSize = unionSorted(setA, setB).length;
  statsEl.innerHTML = `<strong>${labelA} only:</strong> ${onlyA} &nbsp;&nbsp; <strong>Intersection:</strong> ${inter.size} &nbsp;&nbsp; <strong>${labelB} only:</strong> ${onlyB} <br><strong>Union (unique):</strong> ${unionSize}`;

  if (countSpan) countSpan.textContent = `(${setA.size} , ${setB.size})`;

  return {
    onlyA: Array.from(setDifference(setA, setB)).sort(),
    onlyB: Array.from(setDifference(setB, setA)).sort(),
    shared: Array.from(inter).sort()
  };
}

/* render column lists */
function renderColumnList(containerEl, items) {
  containerEl.innerHTML = '';
  if (!items || items.length === 0) {
    containerEl.innerHTML = '<div class="item" style="color:#888">â€”</div>';
    return;
  }
  for (const it of items) {
    const d = document.createElement('div');
    d.className = 'item';
    d.textContent = it;
    containerEl.appendChild(d);
  }
}

/* collapse/show panels and manage active classes */
function collapseAll() {
  panelGoIds.style.display = 'none';
  panelGoTerms.style.display = 'none';
  panelSymbols.style.display = 'none';
  out.style.display = 'none';
  [btnGoIds, btnGoTerms, btnSymbols, btnRaw].forEach(b => b.classList.remove('active'));
}
function showPanel(axis) {
  if (!lastResponse) { alert('No server response stored yet. Click Submit.'); return; }
  if (!lastResponse.annotations || lastResponse.annotations.length < 2) {
    alert('Server response must contain exactly two annotations (A and B).');
    return;
  }

  collapseAll();
  if (axis === 'go_ids') {
    btnGoIds.classList.add('active');
    panelGoIds.style.display = 'block';
    const { setA, setB } = buildSets(lastResponse, 'go_ids');
    const res = drawVenn('venn-goids', setA, setB, 'A', 'B', goidsStats, goidsCount);
    renderColumnList(goidsAList, res.onlyA);
    renderColumnList(goidsBothList, res.shared);
    renderColumnList(goidsBList, res.onlyB);
  } else if (axis === 'go_terms') {
    btnGoTerms.classList.add('active');
    panelGoTerms.style.display = 'block';
    const { setA, setB } = buildSets(lastResponse, 'go_terms');
    const res = drawVenn('venn-goterms', setA, setB, 'A', 'B', gotermsStats, gotermsCount);
    renderColumnList(gotermsAList, res.onlyA);
    renderColumnList(gotermsBothList, res.shared);
    renderColumnList(gotermsBList, res.onlyB);
  } else if (axis === 'symbol') {
    btnSymbols.classList.add('active');
    panelSymbols.style.display = 'block';
    const { setA, setB, arrA, arrB } = buildSets(lastResponse, 'symbol');
    const res = drawVenn('venn-symbols', setA, setB, 'A', 'B', symbolsStats, symbolsCount);
    renderColumnList(symbolsAList, res.onlyA);
    renderColumnList(symbolsBothList, res.shared);
    renderColumnList(symbolsBList, res.onlyB);
  } else if (axis === 'raw') {
    btnRaw.classList.add('active');
    out.style.display = (out.style.display === 'block') ? 'none' : 'block';
  }
}

/* left button listeners */
btnGoIds.addEventListener('click', ()=> showPanel('go_ids'));
btnGoTerms.addEventListener('click', ()=> showPanel('go_terms'));
btnSymbols.addEventListener('click', ()=> showPanel('symbol'));
btnRaw.addEventListener('click', ()=> {
  collapseAll();
  btnRaw.classList.add('active');
  out.style.display = (out.style.display === 'block') ? 'none' : 'block';
});

/* Submit logic (POST then GET fallback). Store response in lastResponse */
btn.addEventListener('click', async ()=> {
  out.textContent = '';
  collapseAll();
  const id1 = en1.value.trim();
  const id2 = en2.value.trim();
  if (!id1 && !id2) { out.textContent = 'Enter at least one Ensembl ID.'; return; }

  setBusy(true, 'Sending request...');
  let resp = null;
  try {
    resp = await postJSON({ id1: id1 || null, id2: id2 || null });
  } catch(e) {
    resp = null;
  }

  if (!resp || (resp.status >= 400 && resp.status !== 400)) {
    setBusy(true, 'POST failed â€” trying GET fallback...');
    try {
      resp = await getFallback({ id1, id2 });
    } catch(e) {
      resp = null;
    }
  }

  if (!resp) {
    out.textContent = 'Request failed (network/CORS). Make sure server is running at http://127.0.0.1:5000';
    setBusy(false, 'Error');
    return;
  }

  const text = await resp.text();
  let parsed = null;
  try { parsed = JSON.parse(text); } catch(e){ parsed = null; }

  lastResponse = parsed || { raw: text };

  out.textContent = tryPretty(text);
  setBusy(false, `HTTP ${resp.status} ${resp.statusText}`);
});
</script>
</body>
</html>
